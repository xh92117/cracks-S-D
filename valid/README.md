# 模型验证工具

这个目录包含了用于验证目标检测和语义分割模型融合效果的脚本。

## 文件说明

- `wbf_fusion.py`: 实现了加权聚类NMS(WCNMS)算法，用于融合检测和分割模型的预测结果
- `validate.py`: 验证脚本，用于测试模型融合效果

## 使用方法

### 1. 环境要求

确保已安装以下依赖：
```bash
pip install ultralytics opencv-python numpy torch scikit-learn
```

### 2. 运行验证脚本

使用以下命令运行验证脚本：

```bash
python validate.py \
    --det-model path/to/detection/model.pt \
    --seg-model path/to/segmentation/model.pt \
    --image path/to/test/image.jpg \
    --output output_directory \
    --det-weight 0.6 \
    --seg-weight 0.4 \
    --conf-threshold 0.25 \
    --iou-threshold 0.5
```

参数说明：
- `--det-model`: 检测模型路径（必需）
- `--seg-model`: 分割模型路径（必需）
- `--image`: 输入图片路径（必需）
- `--output`: 输出目录（可选，默认为'output'）
- `--det-weight`: 检测模型权重（可选，默认为0.6）
- `--seg-weight`: 分割模型权重（可选，默认为0.4）
- `--conf-threshold`: 置信度阈值（可选，默认为0.25）
- `--iou-threshold`: IOU阈值（可选，默认为0.5）

### 3. 输出说明

脚本会在指定的输出目录中生成结果图片，文件名格式为：`result_原图片名.jpg`。结果图片包含：
- 融合后的检测框（绿色）
- 类别标签和置信度分数

## 算法说明

### 加权聚类NMS (WCNMS)

WCNMS算法通过以下步骤融合检测和分割模型的预测结果：

1. 计算所有预测框之间的IOU矩阵
2. 使用DBSCAN聚类算法将重叠框分组
3. 对每个簇内的框进行加权平均，权重基于置信度分数
4. 选择每个簇中置信度最高的标签作为最终标签

### 权重设置

- 检测模型权重（默认0.6）：控制检测模型预测结果的重要性
- 分割模型权重（默认0.4）：控制分割模型预测结果的重要性

### 参数调优建议

1. **IOU阈值**
   - 默认值：0.5
   - 建议范围：0.3-0.7
   - 值越大，合并越严格；值越小，合并越宽松

2. **置信度阈值**
   - 默认值：0.25
   - 建议范围：0.2-0.5
   - 值越大，预测结果越可靠但可能漏检
   - 值越小，检出率更高但可能有误检

3. **模型权重**
   - 建议根据模型性能调整
   - 性能更好的模型可以给予更高的权重
   - 权重总和应该等于1

### 性能优化

1. **计算效率**
   - 使用numpy向量化运算
   - 优化IOU矩阵计算
   - 使用DBSCAN聚类加速框合并

2. **内存使用**
   - 及时释放中间结果
   - 使用生成器处理大量图片
   - 控制中间结果的存储

3. **精度优化**
   - 根据实际场景调整IOU阈值
   - 优化模型权重分配
   - 调整置信度阈值平衡检出率和准确率 